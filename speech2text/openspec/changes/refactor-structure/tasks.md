# Refactor Tasks

- [ ] **Phase 0: Foundations**
    - [ ] Create `core/container.py` and implement DI provider.
    - [ ] Create `domain/` package and define `entities.py`, `value_objects.py`, `events.py`.
    - [ ] Define abstract interfaces in `ports/` (Repository, Storage, Messaging).
- [ ] **Phase 1: Application Layer**
    - [ ] Refactor `services/task_service.py` into `services/task_use_case.py`.
    - [ ] Update API routers to use `Depends` and the DI container.
    - [ ] Create `pipelines/stt/use_cases/process_job.py` for job processing logic.
- [ ] **Phase 2: Infrastructure Adapters**
    - [ ] Implement `MongoTaskRepository` in `adapters/mongo/` implementing `TaskRepositoryPort`.
    - [ ] Implement `MinioStorageAdapter` in `adapters/minio/`.
    - [ ] Implement `RabbitMQAdapter` in `adapters/rabbitmq/`.
    - [ ] Implement `WhisperRunnerAdapter` in `adapters/whisper/`.
    - [ ] Configure Container to bind ports to these adapters.
- [ ] **Phase 3: Worker Modularity**
    - [ ] Move and restructure `worker/` code into `pipelines/stt/` (chunker, transcriber, merger).
    - [ ] Implement `pipelines/base.py` base classes.
    - [ ] Update `internal/consumer/handlers/stt_handler.py` to use the new pipeline structure.
- [ ] **Phase 4: Cross-cutting**
    - [ ] Add contract tests for new Ports.
    - [ ] Update `docs/ARCHITECTURE.md` with the new design.
    - [ ] Verify system with end-to-end tests.
